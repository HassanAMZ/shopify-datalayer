{% if first_time_accessed %}
<script>
    dataLayer.push({
        'event': 'custom_purchase',
        'ecommerce': {

            'timestamp': Shopify.checkout.created_at,
            'transaction_id': {{ order_number }} ,
            'value': {{ checkout.subtotal_price | divided_by: 100.0 }},
            'shipping': {{ order.shipping_price | divided_by: 100.0 }},
            'tax': {{ order.tax_price | divided_by: 100.0 }},
            'coupon': !Shopify.checkout.discount ? coupon_code = '' : coupon_code = Shopify.checkout.discount.code,
            'currency': '{{ currency }}',
            'discount_detials': Shopify.checkout.discount,
            'items': Shopify.checkout.line_items.map((product_line_item, index) => {

                return item = {
                    'item_id': product_line_item.product_id,
                    'item_sku': product_line_item.sku,
                    'item_name': product_line_item.title,
                    'affiliation': Shopify.shop,
                    'price': product_line_item.price,
                    'item_brand': product_line_item.vendor,
                    'item_variant': product_line_item.variant_title,
                    'item_variant_id': product_line_item.variant_id,
                    'quantity': product_line_item.quantity,
                    'currency': '{{ currency }}',
                    'index': index,
                }
            })
        },
        'user_data': Shopify.checkout.billing_address
    }
);
</script>
{% endif %}
