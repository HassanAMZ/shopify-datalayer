{% if first_time_accessed %}
<script>
window.dataLayer = window.dataLayer || [];
</script>
<script>
    dataLayer.push({ ecommerce: null });  // Clear the previous ecommerce object.
    dataLayer.push({
        'event': 'custom_purchase',
        'ecommerce': {
            'timestamp': Shopify.checkout.created_at,
            'transaction_id': {{ order_number }} ,
            'value': {{ checkout.subtotal_price | divided_by: 100.0 }},
            'shipping': {{ order.shipping_price | divided_by: 100.0 }},
            'tax': {{ order.tax_price | divided_by: 100.0 }},
            'coupon': !Shopify.checkout.discount ? coupon_code = '' : coupon_code = Shopify.checkout.discount.code,
            'currency': '{{ currency }}',
            'discount_detials': Shopify.checkout.discount,
            'items': Shopify.checkout.line_items.map((product_line_item, index) => {
                return item = {
                    'item_id': product_line_item.product_id,
                    'item_sku': product_line_item.sku,
                    'item_name': product_line_item.title,
                    'affiliation': Shopify.shop,
                    'price': product_line_item.price,
                    'item_brand': product_line_item.vendor,
                    'item_variant': product_line_item.variant_title,
                    'item_variant_id': product_line_item.variant_id,
                    'quantity': product_line_item.quantity,
                    'currency': '{{ currency }}',
                    'index': index,
                }
            })
        },
   'user_data': {
      user_id: Shopify.checkout.billing_address.id,
      email_address: Shopify.checkout.email,
      phone_number: Shopify.checkout.billing_address.phone,
      address: {
        first_name: Shopify.checkout.billing_address.first_name,
        last_name: Shopify.checkout.billing_address.last_name,
        city: Shopify.checkout.billing_address.city,
        region: Shopify.checkout.billing_address.province,
        postal_code: Shopify.checkout.billing_address.zip,
        country: Shopify.checkout.billing_address.country,
      }
    }
  });
</script>
{% endif %}
